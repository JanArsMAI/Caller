<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ß–∞—Ç-–∫–æ–º–Ω–∞—Ç—ã ¬∑ Go + Redis</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 20px; background: #f0f2f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: #1a73e8; color: white; padding: 20px; text-align: center; }
        .header h1 { margin: 0; font-size: 24px; }
        .content { padding: 20px; }
        
        .room-controls { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .input-group { display: flex; gap: 10px; margin: 15px 0; flex-wrap: wrap; }
        .input-group input { flex: 1; min-width: 200px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; }
        .input-group input:focus { outline: none; border-color: #1a73e8; }
        
        .action-buttons { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        
        .status-board { display: flex; gap: 15px; margin-top: 15px; flex-wrap: wrap; }
        .badge { padding: 8px 16px; background: white; border-radius: 20px; font-size: 14px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        
        .chat-container { background: #f8f9fa; border-radius: 8px; padding: 20px; }
        .chat-messages { min-height: 400px; max-height: 500px; overflow-y: auto; background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        
        .message { margin-bottom: 15px; display: flex; flex-direction: column; }
        .message-header { font-size: 12px; color: #666; margin-bottom: 4px; font-weight: 600; }
        .message-content { padding: 10px 15px; border-radius: 18px; max-width: 70%; word-break: break-word; line-height: 1.4; }
        
        .my-message { align-items: flex-end; }
        .my-message .message-content { background: #1a73e8; color: white; border-bottom-right-radius: 4px; }
        
        .other-message { align-items: flex-start; }
        .other-message .message-content { background: #f0f2f5; color: #1a1a1a; border-bottom-left-radius: 4px; }
        
        .system-message { align-items: center; }
        .system-message .message-content { background: #fff3cd; color: #856404; font-style: italic; max-width: 90%; text-align: center; }
        
        .leave-message .message-content { background: #f8d7da; color: #721c24; font-style: italic; }
        
        .timestamp { font-size: 10px; color: #999; margin-top: 2px; margin-left: 5px; margin-right: 5px; }
        
        button { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        button.primary { background: #1a73e8; color: white; }
        button.primary:hover { background: #1557b0; }
        button.secondary { background: #e0e0e0; color: #333; }
        button.secondary:hover { background: #d0d0d0; }
        button.danger { background: #dc3545; color: white; }
        button.danger:hover { background: #c82333; }
        
        .input-area { display: flex; gap: 10px; }
        .input-area input { flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; }
        .input-area input:focus { outline: none; border-color: #1a73e8; }
        
        .disabled { opacity: 0.5; pointer-events: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí¨ –ß–∞—Ç-–∫–æ–º–Ω–∞—Ç—ã</h1>
        </div>
        
        <div class="content">
            <!-- –ü–∞–Ω–µ–ª—å –∫–æ–º–Ω–∞—Ç—ã -->
            <div class="room-controls">
                <div class="input-group">
                    <input type="text" id="roomInput" placeholder="ID –∫–æ–º–Ω–∞—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä: room-123)">
                    <button class="primary" onclick="joinRoom()">üîó –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
                    <button class="secondary" onclick="createRoom()">‚ú® –°–æ–∑–¥–∞—Ç—å</button>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                <div class="action-buttons">
                    <button class="danger" onclick="leaveRoom()" id="leaveBtn" disabled>üö™ –ü–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
                </div>

                <!-- –°—Ç–∞—Ç—É—Å –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                <div class="status-board">
                    <div class="badge" id="status">‚ö™ –û–∂–∏–¥–∞–Ω–∏–µ</div>
                    <div class="badge" id="roomInfo">üè† –ö–æ–º–Ω–∞—Ç–∞: ‚Äî</div>
                    <div class="badge" id="clientInfo">üë§ ID: ‚Äî</div>
                </div>
            </div>

            <!-- –ß–∞—Ç -->
            <div class="chat-container">
                <div id="messages" class="chat-messages">
                    <div class="message system-message">
                        <div class="message-content">
                            üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –°–æ–∑–¥–∞–π—Ç–µ –∏–ª–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç–µ—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ.
                        </div>
                    </div>
                </div>
                
                <div class="input-area">
                    <input type="text" id="messageInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                           onkeypress="if(event.key==='Enter') sendChat()">
                    <button class="primary" onclick="sendChat()" id="sendBtn" disabled>üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
        let ws = null;
        let myId = null;
        let currentRoom = null;
        let isInRoom = false;
        
        // –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (—á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–µ–π)
        const messageIds = new Set();

        // ========== –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –í–†–ï–ú–ï–ù–ò ==========
        function getCurrentTime() {
            const now = new Date();
            return now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
        }

        // ========== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–ù–û–ü–ö–ê–ú–ò ==========
        function updateUIForRoom(connected) {
            isInRoom = connected;
            document.getElementById('leaveBtn').disabled = !connected;
            document.getElementById('sendBtn').disabled = !connected;
            
            if (!connected) {
                document.getElementById('roomInfo').innerHTML = 'üè† –ö–æ–º–Ω–∞—Ç–∞: ‚Äî';
            }
        }

        // ========== WEBSOCKET ==========
        function connect(roomId) {
            if (ws) {
                ws.close();
            }

            updateStatus('connecting', 'üü° –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
            
            ws = new WebSocket(`ws://localhost:8080/ws?room=${roomId || ''}`);
            
            ws.onopen = () => {
                updateStatus('connected', '‚úÖ –ü–æ–¥–∫–ª—é—á—ë–Ω');
            };
            
            ws.onclose = () => {
                updateStatus('disconnected', 'üî¥ –û—Ç–∫–ª—é—á—ë–Ω');
                updateUIForRoom(false);
                
                // –ï—Å–ª–∏ –º—ã –±—ã–ª–∏ –≤ –∫–æ–º–Ω–∞—Ç–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏
                if (currentRoom) {
                    addSystemMessage(`üîå –û—Ç–∫–ª—é—á–∏–ª–∏—Å—å –æ—Ç –∫–æ–º–Ω–∞—Ç—ã`);
                    currentRoom = null;
                    myId = null;
                }
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log('üì© –ü–æ–ª—É—á–µ–Ω–æ:', data);
                
                switch(data.type) {
                    case 'welcome':
                        myId = data.clientId;
                        currentRoom = data.roomId;
                        document.getElementById('roomInfo').innerHTML = `üè† –ö–æ–º–Ω–∞—Ç–∞: ${currentRoom.slice(0, 8)}...`;
                        document.getElementById('clientInfo').innerHTML = `üë§ ID: ${myId.slice(0, 8)}...`;
                        document.getElementById('roomInput').value = currentRoom;
                        updateUIForRoom(true);
                        addSystemMessage(`‚úÖ –ü–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ`);
                        break;
                        
                    case 'livekit-token':
                        console.log('üé• –ü–æ–ª—É—á–µ–Ω LiveKit —Ç–æ–∫–µ–Ω (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º)');
                        break;
                        
                    case 'chat':
                        // –ü–∞—Ä—Å–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                        let sender = data.from || 'system';
                        let messageText = data.message || data.content || '...';
                        
                        // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è
                        const messageId = `${sender}-${messageText}-${Date.now()}`;
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª–æ –ª–∏ —É–∂–µ —Ç–∞–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                        if (messageIds.has(messageId)) {
                            console.log('‚ö†Ô∏è –î—É–±–ª–∏–∫–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º');
                            return;
                        }
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º ID –≤ –º–Ω–æ–∂–µ—Å—Ç–≤–æ
                        messageIds.add(messageId);
                        
                        if (sender === myId) {
                            addMyMessage(messageText);
                        } else {
                            const displaySender = sender === 'system' ? 'System' : sender.slice(0, 6);
                            addOtherMessage(messageText, displaySender);
                        }
                        break;
                        
                    default:
                        console.log('üì° –î—Ä—É–≥–æ–π —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è:', data.type);
                }
            };
        }

        // ========== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–û–ú–ù–ê–¢–û–ô ==========
        function createRoom() {
            document.getElementById('roomInput').value = '';
            connect('');
            addSystemMessage('‚ú® –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é –∫–æ–º–Ω–∞—Ç—É...');
        }

        function joinRoom() {
            const roomId = document.getElementById('roomInput').value.trim();
            if (roomId) {
                connect(roomId);
                addSystemMessage(`üîó –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è...`);
            } else {
                alert('–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã');
            }
        }

        function leaveRoom() {
            if (ws && isInRoom) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –≤—ã—Ö–æ–¥–µ
                addSystemMessage(`üëã –í—ã –ø–æ–∫–∏–Ω—É–ª–∏ –∫–æ–º–Ω–∞—Ç—É`);
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
                ws.close();
                
                // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
                document.getElementById('roomInput').value = '';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                updateUIForRoom(false);
                currentRoom = null;
                myId = null;
            }
        }

        // ========== –ß–ê–¢ ==========
        function sendChat() {
            const msg = document.getElementById('messageInput').value.trim();
            if (!msg) return;
            
            if (ws?.readyState === WebSocket.OPEN && isInRoom) {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –Ω–∞—à–∏–º ID
                ws.send(JSON.stringify({
                    type: 'chat',
                    message: msg,
                    from: myId,
                    room: currentRoom
                }));
                
                // –°—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≤–æ—ë —Å–æ–æ–±—â–µ–Ω–∏–µ
                addMyMessage(msg);
                document.getElementById('messageInput').value = '';
            } else {
                alert('–í—ã –Ω–µ –≤ –∫–æ–º–Ω–∞—Ç–µ');
            }
        }

        // ========== –§–£–ù–ö–¶–ò–ò –î–û–ë–ê–í–õ–ï–ù–ò–Ø –°–û–û–ë–©–ï–ù–ò–ô ==========
        function addMyMessage(text) {
            const messages = document.getElementById('messages');
            const time = getCurrentTime();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message my-message';
            messageDiv.innerHTML = `
                <div class="message-content">${escapeHtml(text)}</div>
                <div class="timestamp">${time}</div>
            `;
            
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
        }

        function addOtherMessage(text, senderId) {
            const messages = document.getElementById('messages');
            const time = getCurrentTime();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message other-message';
            messageDiv.innerHTML = `
                <div class="message-header">${escapeHtml(senderId)}</div>
                <div class="message-content">${escapeHtml(text)}</div>
                <div class="timestamp">${time}</div>
            `;
            
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
        }

        function addSystemMessage(text, isLeave = false) {
            const messages = document.getElementById('messages');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isLeave ? 'leave-message' : 'system-message'}`;
            messageDiv.innerHTML = `
                <div class="message-content">${isLeave ? 'üëã' : 'üñ•Ô∏è'} ${text}</div>
            `;
            
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
        }

        // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function updateStatus(state, text) {
            const statusEl = document.getElementById('status');
            statusEl.innerHTML = text;
            
            if (state === 'connected') {
                statusEl.style.background = '#d4edda';
                statusEl.style.color = '#155724';
            } else if (state === 'connecting') {
                statusEl.style.background = '#fff3cd';
                statusEl.style.color = '#856404';
            } else {
                statusEl.style.background = '#f8d7da';
                statusEl.style.color = '#721c24';
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendChat();
        });

        console.log('‚úÖ –ß–∞—Ç –∑–∞–≥—Ä—É–∂–µ–Ω');
    </script>
</body>
</html>